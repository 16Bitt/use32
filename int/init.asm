	use32

macro ISR_BLANK number {
isr#number:
	cli
	push dword number
	jmp isr_common_stub
}

macro ISR_ERR number {
isr#number:
	add esp, 1
	push dword number
	jmp isr_common_stub
}

isr_common_stub:
	pusha			;REGS
	mov ax, ds
	push eax		;REGS, EAX

	mov ax, 0x10
	mov ds, ax
	mov es, ax
	mov fs, ax
	mov gs, ax
	push esp		;REGS, EAX, ESP

	call isr_handler

	add esp, 4		;REGS, EAX
	pop ebx			;REGS
	mov ds, bx
	mov es, bx
	mov fs, bx
	mov gs, bx
	popa			;--
	add esp, 4

	iret

macro outb port, value {
	mov al, value
	out port, al
	call io_wait
}

io_wait:
	in al, 0x10 + 0xC
	in al, 0x10 + 0xC
	in al, 0x10 + 0xC
	in al, 0x10 + 0xC
	in al, 0x10 + 0xC
	in al, 0x10 + 0xC
	in al, 0x10 + 0xC
	in al, 0x10 + 0xC
	in al, 0x10 + 0xC
	in al, 0x10 + 0xC
	in al, 0x10 + 0xC
	in al, 0x10 + 0xC
	in al, 0x10 + 0xC
	ret

init_idt:
	push ebp
	mov ebp, esp
	
	;Remap everything in the interrupt controller (messy)
	outb 0x20, 0x11
	outb 0xA0, 0x11
	outb 0x21, 0x20
	outb 0xA1, 0x28
	outb 0x21, 0x04
	outb 0xA1, 0x02
	outb 0x21, 0x01
	outb 0xA1, 0x01
	outb 0x21, 0
	outb 0xA1, 0

	;Initialize a blank jump table
	push 4 * 256
	call malloc
	mov [idt_handlers], eax
	push eax
	push 0
	push 4 * 256
	call memset
	
	;Initialize the IDT
	lidt [idt_main_descriptor]
	sti
	
	;Map common handlers
	push 0
	push err_div_by_zero
	call int_map
	push 1
	push err_debug
	call int_map
	push 0xD
	push err_gpf
	call int_map
	push 0x6
	push err_instruction
	call int_map
	push 0x20
	push err_ghost
	call int_map

	mov esp, ebp
	pop ebp
	ret

idt_handlers: dd 0

idt_main_descriptor:
	dw (8 * 256) - 1	;idt limit
	dd interrupt_table	;idt base

macro MK_INT_ENTRY  num* {
	dw (isr#num shl 16) shr 16
	dw 0x08
	db 0
	db (0x8E or 0x60)
	dw (isr#num shr 16)
}

ISR_BLANK 0
ISR_BLANK 1
ISR_BLANK 2
ISR_BLANK 3
ISR_BLANK 4
ISR_BLANK 5
ISR_BLANK 6
ISR_BLANK 7
ISR_ERR 8
ISR_BLANK 9
ISR_ERR 10
ISR_ERR 11
ISR_ERR 12
ISR_ERR 13
ISR_ERR 14
ISR_BLANK 15
ISR_BLANK 16
ISR_BLANK 17
ISR_BLANK 18
ISR_BLANK 19
ISR_BLANK 20
ISR_BLANK 21
ISR_BLANK 22
ISR_BLANK 23
ISR_BLANK 24
ISR_BLANK 25
ISR_BLANK 26
ISR_BLANK 27
ISR_BLANK 28
ISR_BLANK 29
ISR_BLANK 30
ISR_BLANK 31
ISR_BLANK 32
ISR_BLANK 33
ISR_BLANK 34
ISR_BLANK 35
ISR_BLANK 36
ISR_BLANK 37
ISR_BLANK 38
ISR_BLANK 39
ISR_BLANK 40
ISR_BLANK 41
ISR_BLANK 42
ISR_BLANK 43
ISR_BLANK 44
ISR_BLANK 45
ISR_BLANK 46
ISR_BLANK 47
ISR_BLANK 48
ISR_BLANK 49
ISR_BLANK 50
ISR_BLANK 51
ISR_BLANK 52
ISR_BLANK 53
ISR_BLANK 54
ISR_BLANK 55
ISR_BLANK 56
ISR_BLANK 57
ISR_BLANK 58
ISR_BLANK 59
ISR_BLANK 60
ISR_BLANK 61
ISR_BLANK 62
ISR_BLANK 63
ISR_BLANK 64
ISR_BLANK 65
ISR_BLANK 66
ISR_BLANK 67
ISR_BLANK 68
ISR_BLANK 69
ISR_BLANK 70
ISR_BLANK 71
ISR_BLANK 72
ISR_BLANK 73
ISR_BLANK 74
ISR_BLANK 75
ISR_BLANK 76
ISR_BLANK 77
ISR_BLANK 78
ISR_BLANK 79
ISR_BLANK 80
ISR_BLANK 81
ISR_BLANK 82
ISR_BLANK 83
ISR_BLANK 84
ISR_BLANK 85
ISR_BLANK 86
ISR_BLANK 87
ISR_BLANK 88
ISR_BLANK 89
ISR_BLANK 90
ISR_BLANK 91
ISR_BLANK 92
ISR_BLANK 93
ISR_BLANK 94
ISR_BLANK 95
ISR_BLANK 96
ISR_BLANK 97
ISR_BLANK 98
ISR_BLANK 99
ISR_BLANK 100
ISR_BLANK 101
ISR_BLANK 102
ISR_BLANK 103
ISR_BLANK 104
ISR_BLANK 105
ISR_BLANK 106
ISR_BLANK 107
ISR_BLANK 108
ISR_BLANK 109
ISR_BLANK 110
ISR_BLANK 111
ISR_BLANK 112
ISR_BLANK 113
ISR_BLANK 114
ISR_BLANK 115
ISR_BLANK 116
ISR_BLANK 117
ISR_BLANK 118
ISR_BLANK 119
ISR_BLANK 120
ISR_BLANK 121
ISR_BLANK 122
ISR_BLANK 123
ISR_BLANK 124
ISR_BLANK 125
ISR_BLANK 126
ISR_BLANK 127
ISR_BLANK 128
ISR_BLANK 129
ISR_BLANK 130
ISR_BLANK 131
ISR_BLANK 132
ISR_BLANK 133
ISR_BLANK 134
ISR_BLANK 135
ISR_BLANK 136
ISR_BLANK 137
ISR_BLANK 138
ISR_BLANK 139
ISR_BLANK 140
ISR_BLANK 141
ISR_BLANK 142
ISR_BLANK 143
ISR_BLANK 144
ISR_BLANK 145
ISR_BLANK 146
ISR_BLANK 147
ISR_BLANK 148
ISR_BLANK 149
ISR_BLANK 150
ISR_BLANK 151
ISR_BLANK 152
ISR_BLANK 153
ISR_BLANK 154
ISR_BLANK 155
ISR_BLANK 156
ISR_BLANK 157
ISR_BLANK 158
ISR_BLANK 159
ISR_BLANK 160
ISR_BLANK 161
ISR_BLANK 162
ISR_BLANK 163
ISR_BLANK 164
ISR_BLANK 165
ISR_BLANK 166
ISR_BLANK 167
ISR_BLANK 168
ISR_BLANK 169
ISR_BLANK 170
ISR_BLANK 171
ISR_BLANK 172
ISR_BLANK 173
ISR_BLANK 174
ISR_BLANK 175
ISR_BLANK 176
ISR_BLANK 177
ISR_BLANK 178
ISR_BLANK 179
ISR_BLANK 180
ISR_BLANK 181
ISR_BLANK 182
ISR_BLANK 183
ISR_BLANK 184
ISR_BLANK 185
ISR_BLANK 186
ISR_BLANK 187
ISR_BLANK 188
ISR_BLANK 189
ISR_BLANK 190
ISR_BLANK 191
ISR_BLANK 192
ISR_BLANK 193
ISR_BLANK 194
ISR_BLANK 195
ISR_BLANK 196
ISR_BLANK 197
ISR_BLANK 198
ISR_BLANK 199
ISR_BLANK 200
ISR_BLANK 201
ISR_BLANK 202
ISR_BLANK 203
ISR_BLANK 204
ISR_BLANK 205
ISR_BLANK 206
ISR_BLANK 207
ISR_BLANK 208
ISR_BLANK 209
ISR_BLANK 210
ISR_BLANK 211
ISR_BLANK 212
ISR_BLANK 213
ISR_BLANK 214
ISR_BLANK 215
ISR_BLANK 216
ISR_BLANK 217
ISR_BLANK 218
ISR_BLANK 219
ISR_BLANK 220
ISR_BLANK 221
ISR_BLANK 222
ISR_BLANK 223
ISR_BLANK 224
ISR_BLANK 225
ISR_BLANK 226
ISR_BLANK 227
ISR_BLANK 228
ISR_BLANK 229
ISR_BLANK 230
ISR_BLANK 231
ISR_BLANK 232
ISR_BLANK 233
ISR_BLANK 234
ISR_BLANK 235
ISR_BLANK 236
ISR_BLANK 237
ISR_BLANK 238
ISR_BLANK 239
ISR_BLANK 240
ISR_BLANK 241
ISR_BLANK 242
ISR_BLANK 243
ISR_BLANK 244
ISR_BLANK 245
ISR_BLANK 246
ISR_BLANK 247
ISR_BLANK 248
ISR_BLANK 249
ISR_BLANK 250
ISR_BLANK 251
ISR_BLANK 252
ISR_BLANK 253
ISR_BLANK 254
ISR_BLANK 255
interrupt_table:
MK_INT_ENTRY 0
MK_INT_ENTRY 1
MK_INT_ENTRY 2
MK_INT_ENTRY 3
MK_INT_ENTRY 4
MK_INT_ENTRY 5
MK_INT_ENTRY 6
MK_INT_ENTRY 7
MK_INT_ENTRY 8
MK_INT_ENTRY 9
MK_INT_ENTRY 10
MK_INT_ENTRY 11
MK_INT_ENTRY 12
MK_INT_ENTRY 13
MK_INT_ENTRY 14
MK_INT_ENTRY 15
MK_INT_ENTRY 16
MK_INT_ENTRY 17
MK_INT_ENTRY 18
MK_INT_ENTRY 19
MK_INT_ENTRY 20
MK_INT_ENTRY 21
MK_INT_ENTRY 22
MK_INT_ENTRY 23
MK_INT_ENTRY 24
MK_INT_ENTRY 25
MK_INT_ENTRY 26
MK_INT_ENTRY 27
MK_INT_ENTRY 28
MK_INT_ENTRY 29
MK_INT_ENTRY 30
MK_INT_ENTRY 31
MK_INT_ENTRY 32
MK_INT_ENTRY 33
MK_INT_ENTRY 34
MK_INT_ENTRY 35
MK_INT_ENTRY 36
MK_INT_ENTRY 37
MK_INT_ENTRY 38
MK_INT_ENTRY 39
MK_INT_ENTRY 40
MK_INT_ENTRY 41
MK_INT_ENTRY 42
MK_INT_ENTRY 43
MK_INT_ENTRY 44
MK_INT_ENTRY 45
MK_INT_ENTRY 46
MK_INT_ENTRY 47
MK_INT_ENTRY 48
MK_INT_ENTRY 49
MK_INT_ENTRY 50
MK_INT_ENTRY 51
MK_INT_ENTRY 52
MK_INT_ENTRY 53
MK_INT_ENTRY 54
MK_INT_ENTRY 55
MK_INT_ENTRY 56
MK_INT_ENTRY 57
MK_INT_ENTRY 58
MK_INT_ENTRY 59
MK_INT_ENTRY 60
MK_INT_ENTRY 61
MK_INT_ENTRY 62
MK_INT_ENTRY 63
MK_INT_ENTRY 64
MK_INT_ENTRY 65
MK_INT_ENTRY 66
MK_INT_ENTRY 67
MK_INT_ENTRY 68
MK_INT_ENTRY 69
MK_INT_ENTRY 70
MK_INT_ENTRY 71
MK_INT_ENTRY 72
MK_INT_ENTRY 73
MK_INT_ENTRY 74
MK_INT_ENTRY 75
MK_INT_ENTRY 76
MK_INT_ENTRY 77
MK_INT_ENTRY 78
MK_INT_ENTRY 79
MK_INT_ENTRY 80
MK_INT_ENTRY 81
MK_INT_ENTRY 82
MK_INT_ENTRY 83
MK_INT_ENTRY 84
MK_INT_ENTRY 85
MK_INT_ENTRY 86
MK_INT_ENTRY 87
MK_INT_ENTRY 88
MK_INT_ENTRY 89
MK_INT_ENTRY 90
MK_INT_ENTRY 91
MK_INT_ENTRY 92
MK_INT_ENTRY 93
MK_INT_ENTRY 94
MK_INT_ENTRY 95
MK_INT_ENTRY 96
MK_INT_ENTRY 97
MK_INT_ENTRY 98
MK_INT_ENTRY 99
MK_INT_ENTRY 100
MK_INT_ENTRY 101
MK_INT_ENTRY 102
MK_INT_ENTRY 103
MK_INT_ENTRY 104
MK_INT_ENTRY 105
MK_INT_ENTRY 106
MK_INT_ENTRY 107
MK_INT_ENTRY 108
MK_INT_ENTRY 109
MK_INT_ENTRY 110
MK_INT_ENTRY 111
MK_INT_ENTRY 112
MK_INT_ENTRY 113
MK_INT_ENTRY 114
MK_INT_ENTRY 115
MK_INT_ENTRY 116
MK_INT_ENTRY 117
MK_INT_ENTRY 118
MK_INT_ENTRY 119
MK_INT_ENTRY 120
MK_INT_ENTRY 121
MK_INT_ENTRY 122
MK_INT_ENTRY 123
MK_INT_ENTRY 124
MK_INT_ENTRY 125
MK_INT_ENTRY 126
MK_INT_ENTRY 127
MK_INT_ENTRY 128
MK_INT_ENTRY 129
MK_INT_ENTRY 130
MK_INT_ENTRY 131
MK_INT_ENTRY 132
MK_INT_ENTRY 133
MK_INT_ENTRY 134
MK_INT_ENTRY 135
MK_INT_ENTRY 136
MK_INT_ENTRY 137
MK_INT_ENTRY 138
MK_INT_ENTRY 139
MK_INT_ENTRY 140
MK_INT_ENTRY 141
MK_INT_ENTRY 142
MK_INT_ENTRY 143
MK_INT_ENTRY 144
MK_INT_ENTRY 145
MK_INT_ENTRY 146
MK_INT_ENTRY 147
MK_INT_ENTRY 148
MK_INT_ENTRY 149
MK_INT_ENTRY 150
MK_INT_ENTRY 151
MK_INT_ENTRY 152
MK_INT_ENTRY 153
MK_INT_ENTRY 154
MK_INT_ENTRY 155
MK_INT_ENTRY 156
MK_INT_ENTRY 157
MK_INT_ENTRY 158
MK_INT_ENTRY 159
MK_INT_ENTRY 160
MK_INT_ENTRY 161
MK_INT_ENTRY 162
MK_INT_ENTRY 163
MK_INT_ENTRY 164
MK_INT_ENTRY 165
MK_INT_ENTRY 166
MK_INT_ENTRY 167
MK_INT_ENTRY 168
MK_INT_ENTRY 169
MK_INT_ENTRY 170
MK_INT_ENTRY 171
MK_INT_ENTRY 172
MK_INT_ENTRY 173
MK_INT_ENTRY 174
MK_INT_ENTRY 175
MK_INT_ENTRY 176
MK_INT_ENTRY 177
MK_INT_ENTRY 178
MK_INT_ENTRY 179
MK_INT_ENTRY 180
MK_INT_ENTRY 181
MK_INT_ENTRY 182
MK_INT_ENTRY 183
MK_INT_ENTRY 184
MK_INT_ENTRY 185
MK_INT_ENTRY 186
MK_INT_ENTRY 187
MK_INT_ENTRY 188
MK_INT_ENTRY 189
MK_INT_ENTRY 190
MK_INT_ENTRY 191
MK_INT_ENTRY 192
MK_INT_ENTRY 193
MK_INT_ENTRY 194
MK_INT_ENTRY 195
MK_INT_ENTRY 196
MK_INT_ENTRY 197
MK_INT_ENTRY 198
MK_INT_ENTRY 199
MK_INT_ENTRY 200
MK_INT_ENTRY 201
MK_INT_ENTRY 202
MK_INT_ENTRY 203
MK_INT_ENTRY 204
MK_INT_ENTRY 205
MK_INT_ENTRY 206
MK_INT_ENTRY 207
MK_INT_ENTRY 208
MK_INT_ENTRY 209
MK_INT_ENTRY 210
MK_INT_ENTRY 211
MK_INT_ENTRY 212
MK_INT_ENTRY 213
MK_INT_ENTRY 214
MK_INT_ENTRY 215
MK_INT_ENTRY 216
MK_INT_ENTRY 217
MK_INT_ENTRY 218
MK_INT_ENTRY 219
MK_INT_ENTRY 220
MK_INT_ENTRY 221
MK_INT_ENTRY 222
MK_INT_ENTRY 223
MK_INT_ENTRY 224
MK_INT_ENTRY 225
MK_INT_ENTRY 226
MK_INT_ENTRY 227
MK_INT_ENTRY 228
MK_INT_ENTRY 229
MK_INT_ENTRY 230
MK_INT_ENTRY 231
MK_INT_ENTRY 232
MK_INT_ENTRY 233
MK_INT_ENTRY 234
MK_INT_ENTRY 235
MK_INT_ENTRY 236
MK_INT_ENTRY 237
MK_INT_ENTRY 238
MK_INT_ENTRY 239
MK_INT_ENTRY 240
MK_INT_ENTRY 241
MK_INT_ENTRY 242
MK_INT_ENTRY 243
MK_INT_ENTRY 244
MK_INT_ENTRY 245
MK_INT_ENTRY 246
MK_INT_ENTRY 247
MK_INT_ENTRY 248
MK_INT_ENTRY 249
MK_INT_ENTRY 250
MK_INT_ENTRY 251
MK_INT_ENTRY 252
MK_INT_ENTRY 253
MK_INT_ENTRY 254
MK_INT_ENTRY 255
